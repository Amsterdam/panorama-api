# Generated by Django 3.2.19 on 2023-07-01 13:02
# Hand-edited to recreate the adjacencies view.

import django.contrib.gis.db.models.fields
import django.contrib.postgres.fields
from django.db import migrations, models

ADJACENCY_VIEW = """
CREATE OR REPLACE VIEW public.panoramas_adjacencies_new AS
    SELECT id, from_pano_id, to_pano_id AS pano_id,
        to_filename AS filename, to_path AS path,
        to_surface_type AS surface_type, to_mission_type AS mission_type,
        to_mission_distance AS mission_distance, to_mission_year AS mission_year,
        to_tags AS tags, to_timestamp AS timestamp, to_status AS status,
        to_status_changed AS status_changed,
        relative_distance, relative_heading,
        degrees(atan2(relative_elevation, relative_distance)) AS relative_pitch,
        relative_elevation, from_geolocation_2d_rd,
        to_geolocation_2d_rd AS _geolocation_2d_rd,
        to_geolocation_2d AS _geolocation_2d,
        to_geolocation AS geolocation
    FROM (
        SELECT from_pano.id || '-' || to_pano.id AS id,
            from_pano.pano_id AS from_pano_id, to_pano.pano_id AS to_pano_id,
            to_pano.filename AS to_filename,
            to_pano.path AS to_path,
            to_pano.surface_type AS to_surface_type,
            to_pano.mission_type AS to_mission_type,
            to_pano.mission_distance AS to_mission_distance,
            to_pano.mission_year AS to_mission_year,
            to_pano.tags AS to_tags,
            to_pano.timestamp AS to_timestamp,
            to_pano.status AS to_status,
            to_pano.status_changed AS to_status_changed,
            ST_Distance(geography(to_pano.geolocation),
                geography(from_pano.geolocation)) AS relative_distance,
            degrees(ST_Azimuth(geography(from_pano.geolocation),
                geography(to_pano.geolocation))) AS relative_heading,
            ST_Z(to_pano.geolocation) - ST_Z(from_pano.geolocation) AS relative_elevation,
            from_pano._geolocation_2d_rd AS from_geolocation_2d_rd,
            to_pano._geolocation_2d_rd AS to_geolocation_2d_rd,
            to_pano._geolocation_2d AS to_geolocation_2d,
            to_pano.geolocation AS to_geolocation
        FROM
            panoramas_panorama from_pano, panoramas_panorama to_pano
        WHERE
            to_pano.status = 'done'
    ) subquery1
"""


class Migration(migrations.Migration):

    dependencies = [
        ("panoramas", "0003_update_woz_lowercase"),
    ]

    operations = [
        migrations.RunSQL(sql="DROP VIEW IF EXISTS panoramas_adjacencies_new"),
        migrations.DeleteModel(
            name="Region",
        ),
        migrations.AlterField(
            model_name="mission",
            name="mission_distance",
            field=models.IntegerField(),
        ),
        migrations.AlterField(
            model_name="mission",
            name="mission_year",
            field=models.TextField(max_length=4, null=True),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="_geolocation_2d",
            field=django.contrib.gis.db.models.fields.PointField(null=True, srid=4326),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="_geolocation_2d_rd",
            field=django.contrib.gis.db.models.fields.PointField(null=True, srid=28992),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="mission_distance",
            field=models.IntegerField(),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="mission_type",
            field=models.TextField(default="bi", max_length=16),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="mission_year",
            field=models.TextField(max_length=4, null=True),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="surface_type",
            field=models.CharField(
                choices=[("L", "land"), ("W", "water")], default="L", max_length=1
            ),
        ),
        migrations.AlterField(
            model_name="panorama",
            name="tags",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=32),
                blank=True,
                db_index=True,
                size=None,
            ),
        ),
        migrations.AlterModelTable(
            name="panorama",
            table="panoramas_panorama",
        ),
        migrations.RunSQL(sql=ADJACENCY_VIEW),
    ]
